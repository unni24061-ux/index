<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ULTRA TRACKER PRO</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2964/2964514.png">
  <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlVsdHJhIFdvcmtvdXQgVHJhY2tlciIsCiAgInNob3J0X25hbWUiOiAiVHJhY2tlciIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGEwYTBjIiwKICAidGhlbWVfY29sb3IiOiAiIzBhMGEwYyIsCiAgImljb25zIjogW3siZGVzdGluYXRpb24iOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMjk2NC8yOTY0NTE0LnBuZyIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIn1dCn0=">

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    :root {
      --bg: #0a0a0c; --card: #16161a; --accent: #3b82f6; --success: #10b981; --danger: #ef4444;
      --text: #f8fafc; --text-dim: #94a3b8;
      --chest: #ef4444; --back: #3b82f6; --shoulders: #f59e0b;
      --legs: #10b981; --arms: #8b5cf6; --core: #06b6d4;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { font-family: 'Inter', -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }

    header { background: var(--card); padding: 18px; text-align: center; font-weight: 800; border-bottom: 1px solid #2d2d35; position: sticky; top: 0; z-index: 100; letter-spacing: 1px; }

    .page { display: none; padding: 15px; padding-bottom: 110px; max-width: 500px; margin: 0 auto; animation: slideUp 0.3s ease-out; }
    .page.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    /* Calendar UI */
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
    .cal-cell { aspect-ratio: 1; background: var(--card); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; position: relative; border: 1px solid #222; }
    .cal-cell.today { border: 2px solid var(--accent); }
    .dot-box { display: flex; gap: 3px; margin-top: 4px; height: 6px; }
    .dot { width: 6px; height: 6px; border-radius: 50%; }

    /* Muscle Group UI */
    .muscle-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muscle-btn { padding: 25px; border-radius: 18px; border: none; color: white; font-weight: 800; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: transform 0.1s; }
    .muscle-btn:active { transform: scale(0.96); }

    /* Exercise Items */
    .ex-box { background: var(--card); border: 2px solid var(--accent); padding: 20px; border-radius: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; font-weight: 700; transition: border-color 0.3s; }
    .ex-box.was-done-last { border-color: var(--danger) !important; }

    /* Input & PR Displays */
    .pr-header { background: #1a1a20; padding: 15px; border-radius: 18px; margin-bottom: 20px; border: 1px solid #333; }
    .pr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .pr-mini-box { background: var(--bg); padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #222; }
    .pr-mini-box small { display: block; font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; }
    .pr-mini-box b { font-size: 1.1rem; color: var(--success); }

    .set-row { display: grid; grid-template-columns: 1fr 1fr 1fr 45px 35px; gap: 8px; background: rgba(255,255,255,0.04); padding: 12px; border-radius: 12px; margin-bottom: 10px; align-items: center; }
    input, textarea { background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; width: 100%; text-align: center; }
    
    /* Timer Animations */
    #timerOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.96); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
    .timer-circle { width: 190px; height: 190px; border-radius: 50%; border: 6px solid var(--accent); display: flex; align-items: center; justify-content: center; font-size: 3.5rem; font-weight: 800; margin-bottom: 40px; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); animation: timerGlow 1.5s infinite alternate; }
    @keyframes timerGlow { from { box-shadow: 0 0 10px var(--accent); } to { box-shadow: 0 0 30px var(--accent); } }

    /* Modals for History/Graph */
    .center-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); padding: 25px; border-radius: 20px; width: 90%; max-width: 380px; z-index: 3000; display: none; border: 1px solid #444; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 2500; }

    nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 18px 0; border-top: 1px solid #2d2d35; }
    nav button { background: none; border: none; color: var(--text-dim); cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
    nav button.active { color: var(--accent); }
    
    .btn-finish { width: 100%; padding: 20px; background: var(--success); color: white; border: none; border-radius: 16px; font-weight: 800; margin-top: 25px; cursor: pointer; }
  </style>
</head>
<body>

<header id="headerTitle">CALENDAR</header>

<div id="calendarPage" class="page active">
  <div style="display:flex; justify-content:space-between; padding:10px; align-items:center;">
    <button onclick="changeMonth(-1)" class="material-icons" style="background:none; border:none; color:white;">chevron_left</button>
    <h3 id="monthLabel" style="margin:0;"></h3>
    <button onclick="changeMonth(1)" class="material-icons" style="background:none; border:none; color:white;">chevron_right</button>
  </div>
  <div class="cal-grid" id="calGrid"></div>
</div>

<div id="musclePage" class="page">
  <div id="templateSection" style="margin-bottom:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h4 style="margin:0; color:var(--text-dim)">TEMPLATES</h4>
        <button onclick="saveCurrentAsTemplate()" class="material-icons" style="background:none; border:none; color:var(--accent); cursor:pointer;">add_box</button>
    </div>
    <div id="templateList" style="display:flex; gap:10px; overflow-x:auto; padding:10px 0;"></div>
  </div>

  <div class="muscle-grid">
    <button class="muscle-btn" style="background:var(--chest)" onclick="selMuscle('Chest')"><span class="material-icons">fitness_center</span>CHEST</button>
    <button class="muscle-btn" style="background:var(--back)" onclick="selMuscle('Back')"><span class="material-icons">reorder</span>BACK</button>
    <button class="muscle-btn" style="background:var(--shoulders)" onclick="selMuscle('Shoulders')"><span class="material-icons">architecture</span>SHOULDERS</button>
    <button class="muscle-btn" style="background:var(--legs)" onclick="selMuscle('Legs')"><span class="material-icons">accessibility_new</span>LEGS</button>
    <button class="muscle-btn" style="background:var(--arms)" onclick="selMuscle('Arms')"><span class="material-icons">gesture</span>ARMS</button>
    <button class="muscle-btn" style="background:var(--core)" onclick="selMuscle('Core')"><span class="material-icons">toll</span>CORE</button>
  </div>

  <div id="todaySummary" style="margin-top:25px;"></div>
  <button id="sessionFinishBtn" onclick="saveFullSession()" class="btn-finish" style="display:none;">FINISH SESSION</button>
</div>

<div id="exListPage" class="page">
  <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
    <button onclick="showPage('musclePage')" class="material-icons" style="background:none; border:none; color:white;">arrow_back</button>
    <button onclick="addExPrompt()" class="material-icons" style="background:var(--accent); color:white; border:none; padding:8px; border-radius:10px;">add</button>
  </div>
  <div id="exContainer"></div>
</div>

<div id="inputPage" class="page">
  <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
    <button onclick="openPRHistory()" class="material-icons" style="background:none; border:none; color:var(--accent);">history</button>
    <button onclick="openExGraph()" class="material-icons" style="background:none; border:none; color:var(--accent);">show_chart</button>
  </div>
  
  <div class="pr-header">
    <h2 id="activeExName" style="margin:0; text-align:center;"></h2>
    <div class="pr-grid">
        <div class="pr-mini-box"><small>All-Time PR</small><b id="allTimePR">0kg</b></div>
        <div class="pr-mini-box"><small>Current Month</small><b id="monthPR">0kg</b></div>
    </div>
  </div>

  <div id="setList"></div>
  <button onclick="addSetRow()" style="width:100%; padding:15px; background:none; border:1px dashed #444; color:var(--text-dim); border-radius:12px; margin-top:10px; display:flex; align-items:center; justify-content:center; gap:8px;"><span class="material-icons">add</span> Add Set</button>
  
  <textarea id="exNote" placeholder="Notes / Remarks for this exercise..." style="margin-top:20px; height:90px;"></textarea>
  <button onclick="completeWorkoutStep()" class="btn-finish">FINISH WORKOUT</button>
</div>

<div id="progressionPage" class="page">
  <div style="background:var(--card); padding:20px; border-radius:20px; margin-bottom:20px;">
    <h3 style="margin-top:0;">Profile Details</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:15px;">
      <input type="number" id="curWeight" placeholder="Wt (kg)">
      <input type="number" id="curHeight" placeholder="Ht (cm)">
      <input type="number" id="goalWeight" placeholder="Goal">
    </div>
    <button onclick="saveBodyMetrics()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:700;">Update Profile</button>
  </div>

  <div style="background:var(--card); padding:20px; border-radius:20px; margin-bottom:20px;">
    <h3>Weight Progression</h3>
    <div id="progChart" style="height:150px; display:flex; align-items:flex-end; gap:8px; padding-bottom:10px;"></div>
  </div>

  <div style="background:var(--card); padding:20px; border-radius:20px;">
    <h3>Data Management</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <button onclick="exportData()" style="padding:15px; background:#222; border:1px solid #444; color:white; border-radius:12px; display:flex; align-items:center; gap:8px;"><span class="material-icons">download</span> Export</button>
        <button onclick="importData()" style="padding:15px; background:#222; border:1px solid #444; color:white; border-radius:12px; display:flex; align-items:center; gap:8px;"><span class="material-icons">upload</span> Import</button>
    </div>
  </div>
</div>

<div id="timerOverlay">
  <div class="timer-circle" id="timerValue">60</div>
  <div id="motivationText" style="color:var(--text-dim); margin-bottom:40px; font-style:italic;">Stay Hydrated!</div>
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:80%;">
    <button onclick="startTimer(45)" style="padding:15px; background:var(--card); color:white; border:1px solid #333; border-radius:12px;">45s</button>
    <button onclick="startTimer(60)" style="padding:15px; background:var(--card); color:white; border:1px solid #333; border-radius:12px;">60s</button>
    <button onclick="startTimer(90)" style="padding:15px; background:var(--card); color:white; border:1px solid #333; border-radius:12px;">90s</button>
    <button onclick="startTimer(180)" style="padding:15px; background:var(--card); color:white; border:1px solid #333; border-radius:12px;">180s</button>
  </div>
  <button onclick="closeTimerOverlay()" style="margin-top:40px; border:1px solid var(--danger); background:none; color:var(--danger); padding:10px 40px; border-radius:30px; font-weight:bold;">SKIP</button>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>
<div class="center-modal" id="centerModal"></div>

<nav>
  <button id="navCal" onclick="showPage('calendarPage')" class="active"><span class="material-icons">calendar_today</span>CALENDAR</button>
  <button id="navProg" onclick="showPage('progressionPage')"><span class="material-icons">analytics</span>PROGRESS</button>
</nav>

<script>
// --- APP STATE ---
let state = JSON.parse(localStorage.getItem('ultra_tracker_v5')) || {
    history: [], 
    templates: [],
    library: { 
        Chest:['Bench Press'], Back:['Pull Ups'], Shoulders:['Overhead Press'], 
        Legs:['Squat'], Arms:['Bicep Curl'], Core:['Plank'] 
    },
    metrics: { weightHistory: [] }
};

let viewDate = new Date();
let activeDateStr = "";
let activeMuscle = "";
let activeEx = "";
let tempWorkout = [];
let timerInterval;

const saveState = () => localStorage.setItem('ultra_tracker_v5', JSON.stringify(state));

// --- NAVIGATION ---
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    document.getElementById('headerTitle').innerText = pageId.replace('Page', '').toUpperCase();
    
    if(pageId === 'calendarPage') renderCalendar();
    if(pageId === 'progressionPage') renderProgression();
    if(pageId === 'musclePage') renderTemplates();

    document.getElementById('navCal').classList.toggle('active', pageId === 'calendarPage');
    document.getElementById('navProg').classList.toggle('active', pageId === 'progressionPage');
}

// --- CALENDAR LOGIC ---
function renderCalendar() {
    const grid = document.getElementById('calGrid'); grid.innerHTML = '';
    const m = viewDate.getMonth(), y = viewDate.getFullYear();
    document.getElementById('monthLabel').innerText = new Intl.DateTimeFormat('en-US', {month:'long', year:'numeric'}).format(viewDate);

    const first = new Date(y, m, 1).getDay();
    const days = new Date(y, m+1, 0).getDate();

    for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));

    for(let d=1; d<=days; d++) {
        const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        if(dStr === new Date().toISOString().split('T')[0]) cell.classList.add('today');
        cell.innerHTML = `<div>${d}</div>`;

        const workouts = state.history.filter(h => h.date === dStr);
        if(workouts.length > 0) {
            const dots = document.createElement('div'); dots.className = 'dot-box';
            workouts.forEach(w => {
                const dot = document.createElement('div');
                dot.className = 'dot'; dot.style.background = `var(--${w.muscle.toLowerCase()})`;
                dots.appendChild(dot);
            });
            cell.appendChild(dots);
        }

        // Long Press Delete
        let pressTimer;
        cell.onmousedown = cell.ontouchstart = () => {
            pressTimer = setTimeout(() => {
                if(confirm(`Delete all workout data for ${dStr}?`)) {
                    state.history = state.history.filter(h => h.date !== dStr);
                    saveState(); renderCalendar();
                }
            }, 800);
        };
        cell.onmouseup = cell.onmouseleave = cell.ontouchend = () => clearTimeout(pressTimer);

        cell.onclick = () => { activeDateStr = dStr; checkExistingSession(); showPage('musclePage'); };
        grid.appendChild(cell);
    }
}

function checkExistingSession() {
    const session = state.history.find(h => h.date === activeDateStr);
    const summary = document.getElementById('todaySummary');
    summary.innerHTML = session ? `<h4 style="color:var(--text-dim)">ALREADY LOGGED:</h4>` : "";
    if(session) {
        session.exercises.forEach(ex => {
            const maxKg = Math.max(...ex.sets.map(s => s.kg || 0));
            summary.innerHTML += `<div style="background:var(--card); padding:12px; border-radius:10px; margin-bottom:6px; font-size:14px; border-left:4px solid var(--accent);">${ex.name} â€” <b>${maxKg}kg</b></div>`;
        });
    }
}

// --- MUSCLE & EXERCISE SELECTION ---
function selMuscle(muscle) {
    activeMuscle = muscle;
    renderExerciseList();
    showPage('exListPage');
}

function renderExerciseList() {
    const container = document.getElementById('exContainer'); container.innerHTML = '';
    
    // RED BORDER LOGIC: Find last session of this muscle
    const muscleHistory = state.history.filter(h => h.muscle === activeMuscle).sort((a,b) => b.date.localeCompare(a.date));
    const lastSessionNames = muscleHistory.length > 0 ? muscleHistory[0].exercises.map(e => e.name) : [];

    state.library[activeMuscle].forEach((name, idx) => {
        const box = document.createElement('div');
        box.className = `ex-box ${lastSessionNames.includes(name) ? 'was-done-last' : ''}`;
        box.innerHTML = `<span>${name}</span>
            <div style="display:flex; gap:12px;">
                <span class="material-icons" style="font-size:18px; color:var(--text-dim)" onclick="event.stopPropagation(); editEx(${idx})">edit</span>
                <span class="material-icons" style="font-size:18px; color:var(--danger)" onclick="event.stopPropagation(); removeEx(${idx})">close</span>
            </div>`;
        box.onclick = () => openInputInterface(name);
        container.appendChild(box);
    });
}

function openInputInterface(name) {
    activeEx = name;
    document.getElementById('activeExName').innerText = name;
    
    // PR CALCULATIONS
    const prs = calculatePRs(name);
    document.getElementById('allTimePR').innerText = prs.allTime + "kg";
    document.getElementById('monthPR').innerText = prs.month + "kg";
    
    document.getElementById('setList').innerHTML = '';
    document.getElementById('exNote').value = "";
    addSetRow();
    showPage('inputPage');
}

function calculatePRs(name) {
    let allTime = 0, monthMax = 0;
    const now = new Date();
    state.history.forEach(h => {
        const hDate = new Date(h.date);
        h.exercises.forEach(ex => {
            if(ex.name === name) {
                ex.sets.forEach(s => {
                    if(s.kg > allTime) allTime = s.kg;
                    if(hDate.getMonth() === now.getMonth() && hDate.getFullYear() === now.getFullYear()) {
                        if(s.kg > monthMax) monthMax = s.kg;
                    }
                });
            }
        });
    });
    return { allTime, month: monthMax };
}

function addSetRow() {
    const container = document.getElementById('setList');
    const row = document.createElement('div');
    row.className = 'set-row';
    row.innerHTML = `
        <input type="number" placeholder="kg" class="kg-in">
        <input type="number" placeholder="reps" class="reps-in">
        <span class="material-icons" style="color:var(--success); cursor:pointer;" onclick="saveSetAndTimer(this)">check_circle</span>
        <span class="material-icons" style="color:var(--danger); cursor:pointer;" onclick="this.parentElement.remove()">remove_circle</span>
    `;
    container.appendChild(row);
}

// --- TIMER & MOTIVATION ---
function saveSetAndTimer(btn) {
    btn.style.color = '#333';
    document.getElementById('timerOverlay').style.display = 'flex';
    startTimer(60);
}

function startTimer(sec) {
    clearInterval(timerInterval);
    let timeLeft = sec;
    const timerValue = document.getElementById('timerValue');
    timerValue.innerText = timeLeft;
    
    const lines = ["Breathe deep", "Visualize the growth", "Get ready to push!", "Relax your muscles", "Stay focused"];
    document.getElementById('motivationText').innerText = lines[Math.floor(Math.random() * lines.length)];

    timerInterval = setInterval(() => {
        timeLeft--;
        timerValue.innerText = timeLeft;
        if(timeLeft <= 0) {
            clearInterval(timerInterval);
            if("vibrate" in navigator) navigator.vibrate([200, 100, 200]);
            closeTimerOverlay();
        }
    }, 1000);
}

function closeTimerOverlay() { clearInterval(timerInterval); document.getElementById('timerOverlay').style.display = 'none'; }

// --- COMPLETION LOGIC ---
function completeWorkoutStep() {
    const sets = [];
    document.querySelectorAll('.set-row').forEach(row => {
        const kg = parseFloat(row.querySelector('.kg-in').value);
        const reps = parseInt(row.querySelector('.reps-in').value);
        if(kg && reps) sets.push({kg, reps});
    });

    tempWorkout.push({ 
        name: activeEx, 
        sets, 
        note: document.getElementById('exNote').value 
    });
    
    document.getElementById('sessionFinishBtn').style.display = 'block';
    showPage('musclePage');
}

function saveFullSession() {
    state.history.push({ 
        date: activeDateStr, 
        muscle: activeMuscle, 
        exercises: [...tempWorkout] 
    });
    tempWorkout = [];
    saveState();
    showPage('calendarPage');
}

// --- TEMPLATE FEATURE ---
function saveCurrentAsTemplate() {
    if(tempWorkout.length === 0) return alert("Add some exercises first!");
    const name = prompt("Enter Template Name (e.g. Push Day A):");
    if(name) {
        state.templates.push({ name, muscle: activeMuscle, list: tempWorkout.map(e => e.name) });
        saveState(); renderTemplates();
    }
}

function renderTemplates() {
    const list = document.getElementById('templateList'); list.innerHTML = '';
    state.templates.forEach((t, i) => {
        const tBox = document.createElement('div');
        tBox.style = "background:#1e293b; padding:10px 15px; border-radius:12px; white-space:nowrap; cursor:pointer; border:1px solid #334155; display:flex; gap:8px; align-items:center;";
        tBox.innerHTML = `<span class="material-icons" style="font-size:18px; color:var(--accent)">layers</span> ${t.name}`;
        tBox.onclick = () => loadTemplate(i);
        list.appendChild(tBox);
    });
}

function loadTemplate(idx) {
    const t = state.templates[idx];
    activeMuscle = t.muscle;
    tempWorkout = t.list.map(name => ({ name, sets: [], note: "" }));
    document.getElementById('sessionFinishBtn').style.display = 'block';
    alert(`${t.name} loaded into current session.`);
}

// --- MODALS (HISTORY & GRAPH) ---
function openPRHistory() {
    const logs = [];
    state.history.forEach(h => h.exercises.forEach(ex => {
        if(ex.name === activeEx) {
            const max = Math.max(...ex.sets.map(s => s.kg || 0));
            logs.push(`<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333;"><span>${h.date}</span><b>${max}kg</b></div>`);
        }
    }));
    const html = `<h3 style="margin-top:0;">PR HISTORY</h3><div style="max-height:300px; overflow-y:auto;">${logs.length ? logs.join('') : 'No history yet.'}</div>`;
    openModal(html);
}

function openExGraph() {
    const data = [];
    state.history.forEach(h => h.exercises.forEach(ex => {
        if(ex.name === activeEx) data.push({ date: h.date, val: Math.max(...ex.sets.map(s => s.kg || 0)) });
    }));
    
    let chartHtml = `<h3 style="margin-top:0;">Progression</h3><div style="height:150px; display:flex; align-items:flex-end; gap:5px; border-bottom:2px solid #444;">`;
    const maxVal = Math.max(...data.map(d => d.val)) || 1;
    data.slice(-10).forEach(d => {
        chartHtml += `<div style="flex:1; background:var(--accent); height:${(d.val/maxVal)*100}%; border-radius:3px 3px 0 0;" title="${d.val}kg"></div>`;
    });
    chartHtml += `</div><p style="font-size:12px; color:var(--text-dim); text-align:center;">Last 10 sessions</p>`;
    openModal(chartHtml);
}

function openModal(content) {
    document.getElementById('modalOverlay').style.display = 'block';
    const m = document.getElementById('centerModal');
    m.style.display = 'block';
    m.innerHTML = content + `<button onclick="closeModal()" style="width:100%; margin-top:20px; padding:10px; background:#222; color:white; border:1px solid #444; border-radius:10px;">CLOSE</button>`;
}
function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; document.getElementById('centerModal').style.display = 'none'; }

// --- DATA & METRICS ---
function exportData() {
    const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `workout_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

function importData() {
    const input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = re => { state = JSON.parse(re.target.result); saveState(); window.location.reload(); };
        reader.readAsText(file);
    };
    input.click();
}

function saveBodyMetrics() {
    const w = parseFloat(document.getElementById('curWeight').value);
    if(w) {
        state.metrics.weightHistory.push({ date: new Date().toLocaleDateString(), w });
        saveState(); renderProgression();
    }
}

function renderProgression() {
    const cont = document.getElementById('progChart'); cont.innerHTML = '';
    const history = state.metrics.weightHistory.slice(-8);
    const max = Math.max(...history.map(h => h.w)) || 100;
    history.forEach(h => {
        const bar = document.createElement('div');
        bar.style = `flex:1; background:var(--success); height:${(h.w/max)*100}%; border-radius:4px 4px 0 0; position:relative;`;
        bar.innerHTML = `<span style="position:absolute; top:-20px; width:100%; text-align:center; font-size:10px;">${h.w}</span>`;
        cont.appendChild(bar);
    });
}

function changeMonth(dir) { viewDate.setMonth(viewDate.getMonth() + dir); renderCalendar(); }
function addExPrompt() { const n = prompt("Exercise Name:"); if(n) { state.library[activeMuscle].push(n); saveState(); renderExerciseList(); } }
function editEx(i) { const n = prompt("Rename to:", state.library[activeMuscle][i]); if(n) { state.library[activeMuscle][i] = n; saveState(); renderExerciseList(); } }
function removeEx(i) { if(confirm("Delete exercise?")) { state.library[activeMuscle].splice(i, 1); saveState(); renderExerciseList(); } }

// BOOT
showPage('calendarPage');
</script>
</body>
</html>